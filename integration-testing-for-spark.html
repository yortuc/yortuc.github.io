<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-52121480-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-52121480-1');
	</script>

  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Simbe 0.1" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  
  <title>yortuc</title> 
  
  <style>
	body {
		font-family: verdana;
		line-height: 1.7;
		padding:0;
		margin:0;
	}
	
	a{
		color: #1890ff;
	}
	
	h1, h2, h3 {
		margin-top: 45px;
	}
	
	h1 {
		text-align: center;
	}
	
	blockquote {
		border-left: 4px solid #eee;
		padding-left: 10px;
		font-size: 90%;
		color: #999;
		margin-left: 0;
	}
	
	code {
		background-color: lightgoldenrodyellow;
		padding: 5px;
	}
	
	#logo a{
		float:left;
	}
	
	#logo img{
		width: 100px;
	}
	
	#page-header {
		display: block;
		height: 44px;
		margin: auto;
		margin-top: 20px;
		max-width: 800px;
		border-bottom: 1px solid #ccc;
	}
	
	#menu {
		float:right;
	}	
	
	#menu a{
		line-height:42px;
		margin-left: 12px;
		text-decoration: none;
	}
	
	.post {
		max-width: 800px;
		margin: auto;
	}
	
	.post img {
		width: 100%
	}
	
	.list ul li{
		margin-bottom: 8px;
	}
	
	.linkdate{
		font-size: 85%;
		color: gray;
	}
	
	#page_footer {
		max-width: 800px;
		margin: auto;
		margin-top: 60px;
		margin-bottom: 40px;
	}
	
	.created_by{
		font-size: small;
		display: block;
		text-align: center;
		color: #aaa;
		margin-bottom: 40px;
	}
	
	.created_by a{
		color: #aaa
	}
	
	#comments_section{
		display: block;
	}
  </style>
</head>

<body>
	<div id="page-header">
	<div id="logo">
		<a href="index.html">
			<img src="images/yortuc_logo.png" />
		</a>
	</div>

	<div id="menu">
	<a href="tidbits.html">Tidbits</a>
	<a href="projects.html">Projects</a>
	<a href="index.html">Archive</a>
	<a href="about.html">About</a>
</div>
</div>

	<div class="post">
		<h1>Integration testing for Spark</h1>
<p><img alt="" src="images/integration.png" /></p>
<p>I like unit tests, but, being realistic, some functionality can get away withouth being tested. Especially if you are writing the tests after the actual implementation. (Sorry TDD people, but that kind of people exist on earth)</p>
<h3>Project configuration</h3>
<p>First of all we need to configure the project settings in <code>build.sbt</code>, assuming you have a multi-project structure.</p>
<pre>
    lazy val myProject = project
        .in(file("./my-project"))
        .configs(IntegrationTest)  // here
        .settings(
            Defaults.itSettings,   // and here
            name := "myProject",
            settings,
            libraryDependencies ++= 
                commonDependencies ++ sparkDependencies
        )
</pre>

<p>Since we are using the default settings, the folder for the integration tests will be <code>it</code>. Let's create that folder, and at the end you should have this kind of folder structure:</p>
<pre>
    myProject
    ├── src
    │   ├── it    <-- here it is
    │   │   └── scala
    │   │       └── MyIntegrationTest.scala
    │   ├── main
    │   └── test
    └── target
</pre>

<h3>Write the test</h3>
<p>Let's write one simple integration test. </p>
<pre>
    import org.scalatest.flatspec.AnyFlatSpec
    import com.yortuc.myProject

    class MyIntegrationTest extends AnyFlatSpec with SparkSessionTestWrapper {

        "myProject" should "Read the data from Parquet and save the output correctly" in {

            // run the app as it is
            // in this example with two cli parameters for input and output path
            val inputFilePath = "./input-data.parquet"
            val outputPath = "./output.parquet"
            val expectedOutputPath = "./expected-output.patquet"

            MyProject.main(Array(inputFilePath, outputPath))

            // read the output of the application
            val output = spark.read.parque(outputPath)

            // read the expected results
            val expected = spark.read.parque(expectedOutputPath)

            // compare them.
            // you can use a library such as spark-fast-tests to compare two dataframes or use this naive approach.
            // But, dataframes should be ordered in the same way. 
            val comparison = output.except(expected)

            // there should be no different rows
            assert(comparison.count() == 0)
        }
    }
</pre>

<p>It's very common and hady to create a trait to have a central method to create Spark session inside a test. I will call it something like <code>SparkSessionTestWrapper</code>. Also we can improve this method to read the spark settings from a config file. And then you can choose how are you going to run your tests with spark.</p>
<pre>
    import org.apache.spark.sql.SparkSession

    trait SparkSessionTestWrapper {
      lazy val spark: SparkSession =
        SparkSession
          .builder()
          .master("local")
          .appName("spark test example")
          .getOrCreate()
    }
</pre>

<p>And finally we can run the integration test via <code>sbt</code>.</p>
<pre>
    $ sbt it:test
</pre>

<p>I hope all your tests pass. Happy hacking.</p>
	</div>
	
	<div id="page_footer">
	
	<h3>Comments</h3>
	<div id="comments_section">
		<div id="disqus_thread"></div>
			<script>
			(function() { 
			var d = document, s = d.createElement('script');
			s.src = '//yortuc-com.disqus.com/embed.js';
			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		</div>
	</div>
		
	<span class="created_by">2020 (c) generated by simplest blog engine [<a href="https://github.com/yortuc/simbe" target="_blank">get it here</a>]</span>
</div>
</body>
</html>


